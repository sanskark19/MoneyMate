@page "/transaction"
@inject DatabaseService.Services.dbTransaction dbTransaction
@inject DatabaseService.Services.dbDebt DebtService
@using Coursework.Models
@using DatabaseService.Services
@using Coursework.Shared

<div class="container mt-5">
    <h1 class="h2 mb-3 fw-bold text-black">Transaction Summary</h1>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-success mb-3">
                <div class="card-header">Total Balance</div>
                <div class="card-body">
                    <h5 class="card-title">@balance.ToString("C")</h5>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-danger mb-3">
                <div class="card-header">Cash Outflow</div>
                <div class="card-body">
                    <h5 class="card-title">@OutflowAmount.ToString("C")</h5>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-primary mb-3">
                <div class="card-header">Cash Inflow</div>
                <div class="card-body">
                    <h5 class="card-title">@inflowamount.ToString("C")</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="row mb-5 justify-content-center">
        <div class="col-md-8">
            <input
                type="text"
                class="form-control form-control-lg shadow-sm"
                placeholder="Search Transactions by Title, Type, Tags ..."
                @oninput="e => FilterTransaction(e.Value.ToString())"
            />
        </div>
    </div>

    <!-- Top 5 Latest Transactions -->
    <div class="row mt-4">
        <div class="col-md-12">
            <h2>Top 5 Latest Transactions</h2>
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>Title</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Type</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var transaction in filteredTransactions.Take(5))
                {
                    <tr>
                        <td>@transaction.Title</td>
                        <td>@transaction.Amount.ToString("C")</td>
                        <td>@transaction.Date.ToShortDateString()</td>
                        <td>@transaction.TransactionType</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>

    <!-- All Transactions Table -->
    <div class="row">
        <div class="col-md-12">
            <h2>All Transactions</h2>
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>Title</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Type</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var transaction in filteredTransactions)
                {
                    <tr>
                        <td>@transaction.Title</td>
                        <td>@transaction.Amount.ToString("C")</td>
                        <td>@transaction.Date.ToShortDateString()</td>
                        <td>@transaction.TransactionType</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Cash Outflow Table -->
    <div class="row mt-4">
        <div class="col-md-12">
            <h2>Cash Outflow</h2>
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>Title</th>
                    <th>Amount</th>
                    <th>Date</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var transaction in cashOutFlow)
                {
                    <tr>
                        <td>@transaction.Title</td>
                        <td>@transaction.Amount.ToString("C")</td>
                        <td>@transaction.Date.ToShortDateString()</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Cash Inflow Table -->
    <div class="row mt-4">
        <div class="col-md-12">
            <h2>Cash Inflow</h2>
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>Title</th>
                    <th>Amount</th>
                    <th>Date</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var transaction in cashInFlow)
                {
                    <tr>
                        <td>@transaction.Title</td>
                        <td>@transaction.Amount.ToString("C")</td>
                        <td>@transaction.Date.ToShortDateString()</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    private List<TransactionModel> transactions = new List<TransactionModel>();
    private List<TransactionModel> filteredTransactions = new List<TransactionModel>();
    private List<TransactionModel> cashOutFlow = new List<TransactionModel>();
    private List<TransactionModel> cashInFlow = new List<TransactionModel>();
    private double balance;
    private double OutflowAmount;
    private double inflowamount;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        // Fetch all transactions
        transactions = await dbTransaction.GetTransactionsAsync();

        // Categorize transactions
        filteredTransactions = transactions.ToList();
        cashOutFlow = transactions.Where(t => t.TransactionType == "Debit").OrderByDescending(t => t.Date).ToList();
        cashInFlow = transactions.Where(t => t.TransactionType == "Credit").OrderByDescending(t => t.Date).ToList();

        // Fetch debts and recalculate balance
        await RecalculateBalance();
    }

    private async Task RecalculateBalance()
    {
        OutflowAmount = cashOutFlow.Sum(t => t.Amount);
        inflowamount = cashInFlow.Sum(t => t.Amount);

        var debts = await DebtService.GetDebtsAsync();
        var totalDebt = debts.Where(d => !d.IsCleared).Sum(d => d.Amount);

        balance = inflowamount - OutflowAmount - totalDebt;

        StateHasChanged(); // Refresh the UI
    }

    private void FilterTransaction(string searchTerm)
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredTransactions = transactions.ToList();
        }
        else
        {
            filteredTransactions = transactions
                .Where(t => t.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        StateHasChanged();
    }
}
